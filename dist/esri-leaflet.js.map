{"version":3,"file":"esri-leaflet.js","sources":["../src/EsriLeaflet.js","../src/Util.js","../src/Request.js","../src/Services/Service.js","../src/Services/FeatureLayer.js","../src/Services/MapService.js","../src/Services/ImageService.js","../src/Tasks/Task.js","../src/Tasks/Query.js","../src/Tasks/Find.js","../src/Tasks/Identify.js","../src/Tasks/IdentifyImage.js","../src/Tasks/IdentifyFeatures.js","../src/Layers/BasemapLayer.js","../src/Layers/RasterLayer.js","../src/Layers/DynamicMapLayer.js","../src/Layers/ImageMapLayer.js","../src/Layers/TiledMapLayer.js","../src/Layers/FeatureLayer/FeatureGrid.js","../src/Layers/FeatureLayer/FeatureManager.js","../src/Layers/FeatureLayer/FeatureLayer.js","../src/Controls/Logo.js"],"names":["EsriLeaflet","VERSION","Layers","Services","Controls","Tasks","Util","Support","CORS","window","XMLHttpRequest","pointerEvents","document","documentElement","style","L","esri","clone","obj","target","i","hasOwnProperty","pointsEqual","a","b","length","closeRing","coordinates","push","ringIsClockwise","ringToTest","pt2","total","rLength","pt1","vertexIntersectsVertex","a1","a2","b1","b2","uaT","ubT","uB","ua","ub","arrayIntersectsArray","j","coordinatesContainPoint","point","contains","l","coordinatesContainCoordinates","outer","inner","intersects","convertRingsToGeoJSON","rings","x","outerRing","hole","outerRings","holes","r","ring","slice","polygon","uncontainedHoles","pop","contained","reverse","type","orientRings","poly","output","shift","flattenMultiPolygonRings","extentToBounds","extent","sw","LatLng","ymin","xmin","ne","ymax","xmax","LatLngBounds","boundsToExtent","bounds","latLngBounds","getSouthWest","lng","lat","getNorthEast","spatialReference","wkid","arcgisToGeojson","arcgis","idAttribute","geojson","y","points","paths","geometry","attributes","properties","id","OBJECTID","FID","geojsonToArcGIS","result","features","geometries","responseToFeatureCollection","response","objectIdField","objectIdFieldName","fields","name","featureCollection","results","cleanUrl","url","replace","geojsonTypeToArcGIS","geoJsonType","arcgisGeometryType","serialize","params","data","f","key","value","param","Object","prototype","toString","call","JSON","stringify","valueOf","encodeURIComponent","createRequest","callback","context","httpRequest","onerror","e","error","code","message","onreadystatechange","readyState","parse","responseText","callbacks","_EsriLeafletCallbacks","Request","request","paramString","requestLength","open","send","setRequestHeader","get","JSONP","console","warn","post","XMLHTTP","callbackId","script","DomUtil","create","body","src","responseType","abort","_callback","Service","Evented","extend","options","proxy","useCors","initialize","this","_requestQueue","_authenticating","setOptions","path","_request","metadata","authenticate","token","_runQueue","method","fire","wrappedCallback","_createServiceCallback","bind","apply","service","FeatureLayer","query","Query","addFeature","feature","addResults","undefined","updateFeature","updateResults","deleteFeature","objectIds","deleteResults","featureLayer","MapService","identify","identifyFeatures","find","Find","mapService","ImageService","IdentifyImage","imageService","Task","Class","generateSetter","isArray","match","join","endpoint","_service","setters","setter","offset","limit","outFields","precision","featureIds","returnGeometry","where","outSr","within","_setGeometry","spatialRel","overlaps","nearby","latlng","radius","latLng","geometryType","units","distance","inSr","string","between","start","end","time","simplify","map","factor","mapWidth","Math","abs","getBounds","getWest","getEast","maxAllowableOffset","getSize","orderBy","fieldName","order","orderByFields","bool","run","_cleanParams","count","returnCountOnly","ids","returnIdsOnly","returnExtentOnly","pixelSize","layer","getLatLng","GeoJSON","getLayers","toGeoJSON","text","sr","layers","dynamicLayers","returnZ","returnM","gdbVersion","layerDefs","Identify","setMosaicRule","setRenderingRule","returnCatalogItems","at","getMosaicRule","mosaicRule","getRenderingRule","renderingRule","setPixelSize","getPixelSize","_responseToGeoJSON","location","catalogItems","catalogItemVisibilities","geoJSON","pixel","crs","objectId","Values","values","catalogItemVisibility","identifyImage","IdentifyFeatures","tolerance","on","size","imageDisplay","mapExtent","layerDef","tileProtocol","protocol","BasemapLayer","TileLayer","statics","TILES","Streets","urlTemplate","attributionUrl","hideLogo","logoPosition","minZoom","maxZoom","subdomains","attribution","Topographic","Oceans","OceansLabels","NationalGeographic","DarkGray","DarkGrayLabels","Gray","GrayLabels","Imagery","ImageryLabels","ImageryTransportation","ShadedRelief","ShadedReliefLabels","Terrain","TerrainLabels","config","Error","tileOptions","_getAttributionData","onAdd","_logo","Logo","position","addTo","_updateMapAttribution","onRemove","removeControl","off","getAttribution","attributions","_attributions","c","contributors","contributor","coverageAreas","coverageArea","southWest","bbox","northEast","score","zoomMin","zoomMax","sort","_map","attributionControl","newAttributions","zoom","getZoom","substr","attributionElement","_container","querySelector","innerHTML","maxWidth","basemapLayer","RasterLayer","Layer","opacity","_update","throttle","updateInterval","split","bboxSR","imageSR","_popup","_getPopupData","_resetPopupState","bindPopup","fn","popupOptions","_shouldRenderPopup","_lastClick","popup","_popupFunction","unbindPopup","closePopup","_currentImage","removeLayer","removeEventListener","getEvents","moveend","bringToFront","bringToBack","getOpacity","setOpacity","getTimeRange","from","to","setTimeRange","_renderImage","image","ImageOverlay","once","newImage","oldImage","_bounds","equals","_animatingZoom","_panTransition","_inProgress","_buildExportParams","_requestExport","_renderPopup","content","setLatLng","setContent","openOn","DynamicMapLayer","timeOptions","format","transparent","addEventParent","setLayers","getLayerDefs","setLayerDefs","getTimeOptions","setTimeOptions","setTimeout","identifyRequest","project","_northEast","_southWest","dpi","href","getParamString","dynamicMapLayer","ImageMapLayer","setPixelType","pixelType","getPixelType","setBandIds","bandIds","getBandIds","setNoData","noData","noDataInterpretation","getNoData","getNoDataInterpretation","interpolation","compressionQuality","imageMapLayer","TiledMapLayer","tileUrl","tiledMapLayer","FeatureGrid","cellSize","_reset","_removeCells","events","viewreset","addLayer","removeFrom","_cells","_activeCells","_cellsToLoad","_cellsTotal","_cellNumBounds","_getCellNumBounds","_resetWrap","infinite","_getCellSize","wrapLng","_wrapLng","floor","ceil","wrapLat","_wrapLat","getPixelBounds","cellBounds","min","divideBy","max","_addCells","_removeOtherCells","coords","queue","center","getCenter","Point","z","cellsToLoad","distanceTo","_addCell","_cellCoordsToBounds","nwPoint","multiplyBy","sePoint","add","nw","unproject","wrap","se","_cellCoordsToKey","_keyToCellCoords","kArr","parseInt","_removeCell","cell","cellLeave","_wrapCoords","cellEnter","createCell","wrapNum","getPixelWorldBounds","subtract","BinarySearchIndex","FeatureManager","timeField","timeFilterMode","simplifyFactor","oidCheck","_startTimeIndex","_endTimeIndex","_timeIndex","_currentSnapshot","_activeRequests","_pendingRequests","_requestFeatures","_buildQuery","exceededTransferLimit","_addFeatures","_buildTimeIndexes","createLayers","setWhere","oldSnapshot","newShapshot","pendingRequests","requestError","requestCallback","removeLayers","addLayers","getWhere","oldFrom","oldTo","_filterExistingFeatures","refresh","newFrom","newTo","layersToRemove","_getFeaturesInTimeRange","layersToAdd","indexOf","shouldRemoveLayer","splice","search","startTimes","endTimes","concat","startTimeEntries","endTimeEntries","Date","bulkAdd","timeEntries","_featureWithinTimeRange","date","startDate","endDate","_query","currentIndex","currentElement","resultIndex","minIndex","maxIndex","round","dirty","startIndex","endIndex","items","_layers","createNewLayer","geometryToLayer","newLayer","hasLayer","setLatLngs","updateGeo","getLatLngs","defaultOptions","_popupOptions","onEachFeature","resetStyle","permanent","setFeatureStyle","setStyle","eachFeature","popupContent","groupLayers","gLayer","getFeature","Control","marginTop","marginLeft","marginBottom","marginRight","div","logo"],"mappings":"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","sourcesContent":["var EsriLeaflet = { //jshint ignore:line\n  VERSION: '1.0.0',\n  Layers: {},\n  Services: {},\n  Controls: {},\n  Tasks: {},\n  Util: {},\n  Support: {\n    CORS: !!(window.XMLHttpRequest && 'withCredentials' in new XMLHttpRequest()),\n    pointerEvents: document.documentElement.style.pointerEvents === ''\n  }\n};\n\nif(typeof window !== 'undefined' && window.L){\n  window.L.esri = EsriLeaflet;\n}","(function(EsriLeaflet){\n\n  // shallow object clone for feature properties and attributes\n  // from http://jsperf.com/cloning-an-object/2\n  function clone(obj) {\n    var target = {};\n    for (var i in obj) {\n      if (obj.hasOwnProperty(i)) {\n        target[i] = obj[i];\n      }\n    }\n    return target;\n  }\n\n  // checks if 2 x,y points are equal\n  function pointsEqual(a, b) {\n    for (var i = 0; i < a.length; i++) {\n      if (a[i] !== b[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  // checks if the first and last points of a ring are equal and closes the ring\n  function closeRing(coordinates) {\n    if (!pointsEqual(coordinates[0], coordinates[coordinates.length - 1])) {\n      coordinates.push(coordinates[0]);\n    }\n    return coordinates;\n  }\n\n  // determine if polygon ring coordinates are clockwise. clockwise signifies outer ring, counter-clockwise an inner ring\n  // or hole. this logic was found at http://stackoverflow.com/questions/1165647/how-to-determine-if-a-list-of-polygon-\n  // points-are-in-clockwise-order\n  function ringIsClockwise(ringToTest) {\n    var total = 0,i = 0;\n    var rLength = ringToTest.length;\n    var pt1 = ringToTest[i];\n    var pt2;\n    for (i; i < rLength - 1; i++) {\n      pt2 = ringToTest[i + 1];\n      total += (pt2[0] - pt1[0]) * (pt2[1] + pt1[1]);\n      pt1 = pt2;\n    }\n    return (total >= 0);\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L504-L519\n  function vertexIntersectsVertex(a1, a2, b1, b2) {\n    var uaT = (b2[0] - b1[0]) * (a1[1] - b1[1]) - (b2[1] - b1[1]) * (a1[0] - b1[0]);\n    var ubT = (a2[0] - a1[0]) * (a1[1] - b1[1]) - (a2[1] - a1[1]) * (a1[0] - b1[0]);\n    var uB  = (b2[1] - b1[1]) * (a2[0] - a1[0]) - (b2[0] - b1[0]) * (a2[1] - a1[1]);\n\n    if ( uB !== 0 ) {\n      var ua = uaT / uB;\n      var ub = ubT / uB;\n\n      if ( 0 <= ua && ua <= 1 && 0 <= ub && ub <= 1 ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L521-L531\n  function arrayIntersectsArray(a, b) {\n    for (var i = 0; i < a.length - 1; i++) {\n      for (var j = 0; j < b.length - 1; j++) {\n        if (vertexIntersectsVertex(a[i], a[i + 1], b[j], b[j + 1])) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  // ported from terraformer.js https://github.com/Esri/Terraformer/blob/master/terraformer.js#L470-L480\n  function coordinatesContainPoint(coordinates, point) {\n    var contains = false;\n    for(var i = -1, l = coordinates.length, j = l - 1; ++i < l; j = i) {\n      if (((coordinates[i][1] <= point[1] && point[1] < coordinates[j][1]) ||\n           (coordinates[j][1] <= point[1] && point[1] < coordinates[i][1])) &&\n          (point[0] < (coordinates[j][0] - coordinates[i][0]) * (point[1] - coordinates[i][1]) / (coordinates[j][1] - coordinates[i][1]) + coordinates[i][0])) {\n        contains = !contains;\n      }\n    }\n    return contains;\n  }\n\n  // ported from terraformer-arcgis-parser.js https://github.com/Esri/terraformer-arcgis-parser/blob/master/terraformer-arcgis-parser.js#L106-L113\n  function coordinatesContainCoordinates(outer, inner){\n    var intersects = arrayIntersectsArray(outer, inner);\n    var contains = coordinatesContainPoint(outer, inner[0]);\n    if(!intersects && contains){\n      return true;\n    }\n    return false;\n  }\n\n  // do any polygons in this array contain any other polygons in this array?\n  // used for checking for holes in arcgis rings\n  // ported from terraformer-arcgis-parser.js https://github.com/Esri/terraformer-arcgis-parser/blob/master/terraformer-arcgis-parser.js#L117-L172\n  function convertRingsToGeoJSON(rings){\n    var outerRings = [];\n    var holes = [];\n    var x; // iterator\n    var outerRing; // current outer ring being evaluated\n    var hole; // current hole being evaluated\n\n    // for each ring\n    for (var r = 0; r < rings.length; r++) {\n      var ring = closeRing(rings[r].slice(0));\n      if(ring.length < 4){\n        continue;\n      }\n      // is this ring an outer ring? is it clockwise?\n      if(ringIsClockwise(ring)){\n        var polygon = [ ring ];\n        outerRings.push(polygon); // push to outer rings\n      } else {\n        holes.push(ring); // counterclockwise push to holes\n      }\n    }\n\n    var uncontainedHoles = [];\n\n    // while there are holes left...\n    while(holes.length){\n      // pop a hole off out stack\n      hole = holes.pop();\n\n      // loop over all outer rings and see if they contain our hole.\n      var contained = false;\n      for (x = outerRings.length - 1; x >= 0; x--) {\n        outerRing = outerRings[x][0];\n        if(coordinatesContainCoordinates(outerRing, hole)){\n          // the hole is contained push it into our polygon\n          outerRings[x].push(hole);\n          contained = true;\n          break;\n        }\n      }\n\n      // ring is not contained in any outer ring\n      // sometimes this happens https://github.com/Esri/esri-leaflet/issues/320\n      if(!contained){\n        uncontainedHoles.push(hole);\n      }\n    }\n\n    // if we couldn't match any holes using contains we can try intersects...\n    while(uncontainedHoles.length){\n      // pop a hole off out stack\n      hole = uncontainedHoles.pop();\n\n      // loop over all outer rings and see if any intersect our hole.\n      var intersects = false;\n      for (x = outerRings.length - 1; x >= 0; x--) {\n        outerRing = outerRings[x][0];\n        if(arrayIntersectsArray(outerRing, hole)){\n          // the hole is contained push it into our polygon\n          outerRings[x].push(hole);\n          intersects = true;\n          break;\n        }\n      }\n\n      if(!intersects) {\n        outerRings.push([hole.reverse()]);\n      }\n    }\n\n    if(outerRings.length === 1){\n      return {\n        type: 'Polygon',\n        coordinates: outerRings[0]\n      };\n    } else {\n      return {\n        type: 'MultiPolygon',\n        coordinates: outerRings\n      };\n    }\n  }\n\n  // This function ensures that rings are oriented in the right directions\n  // outer rings are clockwise, holes are counterclockwise\n  // used for converting GeoJSON Polygons to ArcGIS Polygons\n  function orientRings(poly){\n    var output = [];\n    var polygon = poly.slice(0);\n    var outerRing = closeRing(polygon.shift().slice(0));\n    if(outerRing.length >= 4){\n      if(!ringIsClockwise(outerRing)){\n        outerRing.reverse();\n      }\n\n      output.push(outerRing);\n\n      for (var i = 0; i < polygon.length; i++) {\n        var hole = closeRing(polygon[i].slice(0));\n        if(hole.length >= 4){\n          if(ringIsClockwise(hole)){\n            hole.reverse();\n          }\n          output.push(hole);\n        }\n      }\n    }\n\n    return output;\n  }\n\n  // This function flattens holes in multipolygons to one array of polygons\n  // used for converting GeoJSON Polygons to ArcGIS Polygons\n  function flattenMultiPolygonRings(rings){\n    var output = [];\n    for (var i = 0; i < rings.length; i++) {\n      var polygon = orientRings(rings[i]);\n      for (var x = polygon.length - 1; x >= 0; x--) {\n        var ring = polygon[x].slice(0);\n        output.push(ring);\n      }\n    }\n    return output;\n  }\n\n  // convert an extent (ArcGIS) to LatLngBounds (Leaflet)\n  EsriLeaflet.Util.extentToBounds = function(extent){\n    var sw = new L.LatLng(extent.ymin, extent.xmin);\n    var ne = new L.LatLng(extent.ymax, extent.xmax);\n    return new L.LatLngBounds(sw, ne);\n  };\n\n  // convert an LatLngBounds (Leaflet) to extent (ArcGIS)\n  EsriLeaflet.Util.boundsToExtent = function(bounds) {\n    bounds = L.latLngBounds(bounds);\n    return {\n      'xmin': bounds.getSouthWest().lng,\n      'ymin': bounds.getSouthWest().lat,\n      'xmax': bounds.getNorthEast().lng,\n      'ymax': bounds.getNorthEast().lat,\n      'spatialReference': {\n        'wkid' : 4326\n      }\n    };\n  };\n\n  EsriLeaflet.Util.arcgisToGeojson = function (arcgis, idAttribute){\n    var geojson = {};\n\n    if(typeof arcgis.x === 'number' && typeof arcgis.y === 'number'){\n      geojson.type = 'Point';\n      geojson.coordinates = [arcgis.x, arcgis.y];\n    }\n\n    if(arcgis.points){\n      geojson.type = 'MultiPoint';\n      geojson.coordinates = arcgis.points.slice(0);\n    }\n\n    if(arcgis.paths) {\n      if(arcgis.paths.length === 1){\n        geojson.type = 'LineString';\n        geojson.coordinates = arcgis.paths[0].slice(0);\n      } else {\n        geojson.type = 'MultiLineString';\n        geojson.coordinates = arcgis.paths.slice(0);\n      }\n    }\n\n    if(arcgis.rings) {\n      geojson = convertRingsToGeoJSON(arcgis.rings.slice(0));\n    }\n\n    if(arcgis.geometry || arcgis.attributes) {\n      geojson.type = 'Feature';\n      geojson.geometry = (arcgis.geometry) ? EsriLeaflet.Util.arcgisToGeojson(arcgis.geometry) : null;\n      geojson.properties = (arcgis.attributes) ? clone(arcgis.attributes) : null;\n      if(arcgis.attributes) {\n        geojson.id =  arcgis.attributes[idAttribute] || arcgis.attributes.OBJECTID || arcgis.attributes.FID;\n      }\n    }\n\n    return geojson;\n  };\n\n  // GeoJSON -> ArcGIS\n  EsriLeaflet.Util.geojsonToArcGIS = function(geojson, idAttribute){\n    idAttribute = idAttribute || 'OBJECTID';\n    var spatialReference = { wkid: 4326 };\n    var result = {};\n    var i;\n\n    switch(geojson.type){\n    case 'Point':\n      result.x = geojson.coordinates[0];\n      result.y = geojson.coordinates[1];\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiPoint':\n      result.points = geojson.coordinates.slice(0);\n      result.spatialReference = spatialReference;\n      break;\n    case 'LineString':\n      result.paths = [geojson.coordinates.slice(0)];\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiLineString':\n      result.paths = geojson.coordinates.slice(0);\n      result.spatialReference = spatialReference;\n      break;\n    case 'Polygon':\n      result.rings = orientRings(geojson.coordinates.slice(0));\n      result.spatialReference = spatialReference;\n      break;\n    case 'MultiPolygon':\n      result.rings = flattenMultiPolygonRings(geojson.coordinates.slice(0));\n      result.spatialReference = spatialReference;\n      break;\n    case 'Feature':\n      if(geojson.geometry) {\n        result.geometry = EsriLeaflet.Util.geojsonToArcGIS(geojson.geometry, idAttribute);\n      }\n      result.attributes = (geojson.properties) ? clone(geojson.properties) : {};\n      if(geojson.id){\n        result.attributes[idAttribute] = geojson.id;\n      }\n      break;\n    case 'FeatureCollection':\n      result = [];\n      for (i = 0; i < geojson.features.length; i++){\n        result.push(EsriLeaflet.Util.geojsonToArcGIS(geojson.features[i], idAttribute));\n      }\n      break;\n    case 'GeometryCollection':\n      result = [];\n      for (i = 0; i < geojson.geometries.length; i++){\n        result.push(EsriLeaflet.Util.geojsonToArcGIS(geojson.geometries[i], idAttribute));\n      }\n      break;\n    }\n\n    return result;\n  };\n\n  EsriLeaflet.Util.responseToFeatureCollection = function(response, idAttribute){\n    var objectIdField;\n\n    if(idAttribute){\n      objectIdField = idAttribute;\n    } else if(response.objectIdFieldName){\n      objectIdField = response.objectIdFieldName;\n    } else if(response.fields) {\n      for (var j = 0; j <= response.fields.length - 1; j++) {\n        if(response.fields[j].type === 'esriFieldTypeOID') {\n          objectIdField = response.fields[j].name;\n          break;\n        }\n      }\n    } else {\n      objectIdField = 'OBJECTID';\n    }\n\n    var featureCollection = {\n      type: 'FeatureCollection',\n      features: []\n    };\n    var features = response.features || response.results;\n    if(features.length){\n      for (var i = features.length - 1; i >= 0; i--) {\n        featureCollection.features.push(EsriLeaflet.Util.arcgisToGeojson(features[i], objectIdField));\n      }\n    }\n\n    return featureCollection;\n  };\n\n    // trim whitespace and add a tailing slash is needed to a url\n  EsriLeaflet.Util.cleanUrl = function(url){\n    url = url.replace(/\\s\\s*/g, '');\n\n    //add a trailing slash to the url if the user omitted it\n    if(url[url.length-1] !== '/'){\n      url += '/';\n    }\n\n    return url;\n  };\n\n  EsriLeaflet.Util.geojsonTypeToArcGIS = function (geoJsonType) {\n    var arcgisGeometryType;\n    switch (geoJsonType) {\n    case 'Point':\n      arcgisGeometryType = 'esriGeometryPoint';\n      break;\n    case 'MultiPoint':\n      arcgisGeometryType = 'esriGeometryMultipoint';\n      break;\n    case 'LineString':\n      arcgisGeometryType = 'esriGeometryPolyline';\n      break;\n    case 'MultiLineString':\n      arcgisGeometryType = 'esriGeometryPolyline';\n      break;\n    case 'Polygon':\n      arcgisGeometryType = 'esriGeometryPolygon';\n      break;\n    case 'MultiPolygon':\n      arcgisGeometryType = 'esriGeometryPolygon';\n      break;\n    }\n    return arcgisGeometryType;\n  };\n\n})(EsriLeaflet);","(function(EsriLeaflet){\n\n  var callbacks = 0;\n\n  window._EsriLeafletCallbacks = {};\n\n  function serialize(params){\n    var data = '';\n\n    params.f = 'json';\n\n    for (var key in params){\n      if(params.hasOwnProperty(key)){\n        var param = params[key];\n        var type = Object.prototype.toString.call(param);\n        var value;\n\n        if(data.length){\n          data += '&';\n        }\n\n        if(type === '[object Array]' || type === '[object Object]'){\n          value = JSON.stringify(param);\n        } else if (type === '[object Date]'){\n          value = param.valueOf();\n        } else {\n          value = param;\n        }\n\n        data += encodeURIComponent(key) + '=' + encodeURIComponent(value);\n      }\n    }\n\n    return data;\n  }\n\n  function createRequest(callback, context){\n    var httpRequest = new XMLHttpRequest();\n\n    httpRequest.onerror = function(e) {\n      callback.call(context, {\n        error: {\n          code: 500,\n          message: 'XMLHttpRequest error'\n        }\n      }, null);\n    };\n\n    httpRequest.onreadystatechange = function(){\n      var response;\n      var error;\n\n      if (httpRequest.readyState === 4) {\n        try {\n          response = JSON.parse(httpRequest.responseText);\n        } catch(e) {\n          response = null;\n          error = {\n            code: 500,\n            message: 'Could not parse response as JSON.'\n          };\n        }\n\n        if (!error && response.error) {\n          error = response.error;\n          response = null;\n        }\n\n        callback.call(context, error, response);\n      }\n    };\n\n    return httpRequest;\n  }\n\n  // AJAX handlers for CORS (modern browsers) or JSONP (older browsers)\n  EsriLeaflet.Request = {\n    request: function(url, params, callback, context){\n      var paramString = serialize(params);\n      var httpRequest = createRequest(callback, context);\n      var requestLength = (url + '?' + paramString).length;\n\n      // request is less then 2000 characters and the browser supports CORS, make GET request with XMLHttpRequest\n      if(requestLength <= 2000 && L.esri.Support.CORS){\n        httpRequest.open('GET', url + '?' + paramString);\n        httpRequest.send(null);\n\n      // request is less more then 2000 characters and the browser supports CORS, make POST request with XMLHttpRequest\n      } else if (requestLength > 2000 && L.esri.Support.CORS){\n        httpRequest.open('POST', url);\n        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        httpRequest.send(paramString);\n\n      // request is less more then 2000 characters and the browser does not support CORS, make a JSONP request\n      } else if(requestLength <= 2000 && !L.esri.Support.CORS){\n        return L.esri.Request.get.JSONP(url, params, callback, context);\n\n      // request is longer then 2000 characters and the browser does not support CORS, log a warning\n      } else {\n        if(console && console.warn){\n          console.warn('a request to ' + url + ' was longer then 2000 characters and this browser cannot make a cross-domain post request. Please use a proxy http://esri.github.io/esri-leaflet/api-reference/request.html');\n          return;\n        }\n      }\n\n      return httpRequest;\n    },\n    post: {\n      XMLHTTP: function (url, params, callback, context) {\n        var httpRequest = createRequest(callback, context);\n        httpRequest.open('POST', url);\n        httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');\n        httpRequest.send(serialize(params));\n\n        return httpRequest;\n      }\n    },\n\n    get: {\n      CORS: function (url, params, callback, context) {\n        var httpRequest = createRequest(callback, context);\n\n        httpRequest.open('GET', url + '?' + serialize(params), true);\n        httpRequest.send(null);\n\n        return httpRequest;\n      },\n      JSONP: function(url, params, callback, context){\n        var callbackId = 'c' + callbacks;\n\n        params.callback = 'window._EsriLeafletCallbacks.' + callbackId;\n\n        var script = L.DomUtil.create('script', null, document.body);\n        script.type = 'text/javascript';\n        script.src = url + '?' +  serialize(params);\n        script.id = callbackId;\n\n        window._EsriLeafletCallbacks[callbackId] = function(response){\n          if(window._EsriLeafletCallbacks[callbackId] !== true){\n            var error;\n            var responseType = Object.prototype.toString.call(response);\n\n            if(!(responseType === '[object Object]' || responseType === '[object Array]')){\n              error = {\n                error: {\n                  code: 500,\n                  message: 'Expected array or object as JSONP response'\n                }\n              };\n              response = null;\n            }\n\n            if (!error && response.error) {\n              error = response;\n              response = null;\n            }\n\n            callback.call(context, error, response);\n            window._EsriLeafletCallbacks[callbackId] = true;\n          }\n        };\n\n        callbacks++;\n\n        return {\n          id: callbackId,\n          url: script.src,\n          abort: function(){\n            window._EsriLeafletCallbacks._callback[callbackId]({\n              code: 0,\n              message: 'Request aborted.'\n            });\n          }\n        };\n      }\n    }\n  };\n\n  // Choose the correct AJAX handler depending on CORS support\n  EsriLeaflet.get = (EsriLeaflet.Support.CORS) ? EsriLeaflet.Request.get.CORS : EsriLeaflet.Request.get.JSONP;\n\n  // Always use XMLHttpRequest for posts\n  EsriLeaflet.post = EsriLeaflet.Request.post.XMLHTTP;\n\n  // expose a common request method the uses GET\\POST based on request length\n  EsriLeaflet.request = EsriLeaflet.Request.request;\n\n})(EsriLeaflet);","EsriLeaflet.Services.Service = L.Evented.extend({\n\n  options: {\n    proxy: false,\n    useCors: EsriLeaflet.Support.CORS\n  },\n\n  initialize: function (url, options) {\n    this.url = EsriLeaflet.Util.cleanUrl(url);\n    this._requestQueue = [];\n    this._authenticating = false;\n    L.Util.setOptions(this, options);\n  },\n\n  get: function (path, params, callback, context) {\n    return this._request('get', path, params, callback, context);\n  },\n\n  post: function (path, params, callback, context) {\n    return this._request('post', path, params, callback, context);\n  },\n\n  request: function (path, params, callback, context) {\n    return this._request('request', path, params, callback, context);\n  },\n\n  metadata: function (callback, context) {\n    return this._request('get', '', {}, callback, context);\n  },\n\n  authenticate: function(token){\n    this._authenticating = false;\n    this.options.token = token;\n    this._runQueue();\n    return this;\n  },\n\n  _request: function(method, path, params, callback, context){\n    this.fire('requeststart', {\n      url: this.url + path,\n      params: params,\n      method: method\n    }, true);\n\n    var wrappedCallback = this._createServiceCallback(method, path, params, callback, context);\n\n    if (this.options.token) {\n      params.token = this.options.token;\n    }\n\n    if (this._authenticating) {\n      this._requestQueue.push([method, path, params, callback, context]);\n      return;\n    } else {\n      var url = (this.options.proxy) ? this.options.proxy + '?' + this.url + path : this.url + path;\n\n      if((method === 'get' || method === 'request') && !this.options.useCors){\n        return EsriLeaflet.Request.get.JSONP(url, params, wrappedCallback);\n      } else {\n        return EsriLeaflet[method](url, params, wrappedCallback);\n      }\n    }\n  },\n\n  _createServiceCallback: function(method, path, params, callback, context){\n    var request = [method, path, params, callback, context];\n\n    return L.Util.bind(function(error, response){\n\n      if (error && (error.code === 499 || error.code === 498)) {\n        this._authenticating = true;\n\n        this._requestQueue.push(request);\n\n        this.fire('authenticationrequired', {\n          authenticate: L.Util.bind(this.authenticate, this)\n        }, true);\n      } else {\n        callback.call(context, error, response);\n\n        if(error) {\n          this.fire('requesterror', {\n            url: this.url + path,\n            params: params,\n            message: error.message,\n            code: error.code,\n            method: method\n          }, true);\n        } else {\n          this.fire('requestsuccess', {\n            url: this.url + path,\n            params: params,\n            response: response,\n            method: method\n          }, true);\n        }\n\n        this.fire('requestend', {\n          url: this.url + path,\n          params: params,\n          method: method\n        }, true);\n      }\n    }, this);\n  },\n\n  _runQueue: function(){\n    for (var i = this._requestQueue.length - 1; i >= 0; i--) {\n      var request = this._requestQueue[i];\n      var method = request.shift();\n      this[method].apply(this, request);\n    }\n    this._requestQueue = [];\n  }\n\n});\n\nEsriLeaflet.Services.service = function(url, params){\n  return new EsriLeaflet.Services.Service(url, params);\n};","EsriLeaflet.Services.FeatureLayer = EsriLeaflet.Services.Service.extend({\n\n  options: {\n    idAttribute: 'OBJECTID'\n  },\n\n  query: function(){\n    return new EsriLeaflet.Tasks.Query(this);\n  },\n\n  addFeature: function(feature, callback, context) {\n    delete feature.id;\n\n    feature = EsriLeaflet.Util.geojsonToArcGIS(feature);\n\n    return this.post('addFeatures', {\n      features: [feature]\n    }, function(error, response){\n      var result = (response && response.addResults) ? response.addResults[0] : undefined;\n      if(callback){\n        callback.call(this, error || response.addResults[0].error, result);\n      }\n    }, context);\n  },\n\n  updateFeature: function(feature, callback, context) {\n    feature = EsriLeaflet.Util.geojsonToArcGIS(feature, this.options.idAttribute);\n\n    return this.post('updateFeatures', {\n      features: [feature]\n    }, function(error, response){\n      var result = (response && response.updateResults) ? response.updateResults[0] : undefined;\n      if(callback){\n        callback.call(context, error || response.updateResults[0].error, result);\n      }\n    }, context);\n  },\n\n  deleteFeature: function(id, callback, context) {\n    return this.post('deleteFeatures', {\n      objectIds: id\n    }, function(error, response){\n      var result = (response && response.deleteResults) ? response.deleteResults[0] : undefined;\n      if(callback){\n        callback.call(context, error || response.deleteResults[0].error, result);\n      }\n    }, context);\n  }\n\n});\n\nEsriLeaflet.Services.featureLayer = function(url, options) {\n  return new EsriLeaflet.Services.FeatureLayer(url, options);\n};","EsriLeaflet.Services.MapService = EsriLeaflet.Services.Service.extend({\n\n  identify: function () {\n    return new EsriLeaflet.Tasks.identifyFeatures(this);\n  },\n\n  find: function () {\n    return new EsriLeaflet.Tasks.Find(this);\n  },\n\n  query: function () {\n    return new EsriLeaflet.Tasks.Query(this);\n  }\n\n});\n\nEsriLeaflet.Services.mapService = function(url, params){\n  return new EsriLeaflet.Services.MapService(url, params);\n};","EsriLeaflet.Services.ImageService = EsriLeaflet.Services.Service.extend({\n\n  query: function () {\n    return new EsriLeaflet.Tasks.Query(this);\n  },\n\n  identify: function() {\n    return new EsriLeaflet.Tasks.IdentifyImage(this);\n  }\n});\n\nEsriLeaflet.Services.imageService = function(url, params){\n  return new EsriLeaflet.Services.ImageService(url, params);\n};","EsriLeaflet.Tasks.Task = L.Class.extend({\n\n  options: {\n    proxy: false,\n    useCors: EsriLeaflet.Support.CORS\n  },\n\n  //Generate a method for each methodName:paramName in the setters for this task.\n  generateSetter: function(param, context){\n    var isArray = param.match(/([a-zA-Z]+)\\[\\]/);\n\n    param = (isArray) ? isArray[1] : param;\n\n    if(isArray){\n      return L.Util.bind(function(value){\n        // this.params[param] = (this.params[param]) ? this.params[param] + ',' : '';\n        if (L.Util.isArray(value)) {\n          this.params[param] = value.join(',');\n        } else {\n          this.params[param] = value;\n        }\n        return this;\n      }, context);\n    } else {\n      return L.Util.bind(function(value){\n        this.params[param] = value;\n        return this;\n      }, context);\n    }\n  },\n\n  initialize: function(endpoint, options){\n    // endpoint can be either a url to an ArcGIS Rest Service or an instance of EsriLeaflet.Service\n    if(endpoint.url && endpoint.request){\n      this._service = endpoint;\n      this.url = endpoint.url;\n    } else {\n      this.url = EsriLeaflet.Util.cleanUrl(endpoint);\n    }\n\n    // clone default params into this object\n    this.params = L.Util.extend({}, this.params || {});\n\n    // generate setter methods based on the setters object implimented a child class\n    if(this.setters){\n      for (var setter in this.setters){\n        var param = this.setters[setter];\n        this[setter] = this.generateSetter(param, this);\n      }\n    }\n\n    L.Util.setOptions(this, options);\n  },\n\n  token: function(token){\n    if(this._service){\n      this._service.authenticate(token);\n    } else {\n      this.params.token = token;\n    }\n    return this;\n  },\n\n  request: function(callback, context){\n    if(this._service){\n      return this._service.request(this.path, this.params, callback, context);\n    } else {\n      return this._request('request', this.path, this.params, callback, context);\n    }\n  },\n\n  _request: function(method, path, params, callback, context){\n    var url = (this.options.proxy) ? this.options.proxy + '?' + this.url + path : this.url + path;\n    if((method === 'get' || method === 'request') && !this.options.useCors){\n      return EsriLeaflet.Request.get.JSONP(url, params, callback, context);\n    } else{\n      return EsriLeaflet[method](url, params, callback, context);\n    }\n  }\n});","EsriLeaflet.Tasks.Query = EsriLeaflet.Tasks.Task.extend({\n  setters: {\n    'offset': 'offset',\n    'limit': 'limit',\n    'outFields': 'fields[]',\n    'precision': 'geometryPrecision',\n    'featureIds': 'objectIds[]',\n    'returnGeometry': 'returnGeometry',\n    'token': 'token'\n  },\n\n  path: 'query',\n\n  params: {\n    returnGeometry: true,\n    where: '1=1',\n    outSr: 4326,\n    outFields: '*'\n  },\n\n  within: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelContains'; // will make code read layer within geometry, to the api this will reads geometry contains layer\n    return this;\n  },\n\n  intersects: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelIntersects';\n    return this;\n  },\n\n  contains: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelWithin'; // will make code read layer contains geometry, to the api this will reads geometry within layer\n    return this;\n  },\n\n  // crosses: function(geometry){\n  //   this._setGeometry(geometry);\n  //   this.params.spatialRel = 'esriSpatialRelCrosses';\n  //   return this;\n  // },\n\n  // touches: function(geometry){\n  //   this._setGeometry(geometry);\n  //   this.params.spatialRel = 'esriSpatialRelTouches';\n  //   return this;\n  // },\n\n  overlaps: function(geometry){\n    this._setGeometry(geometry);\n    this.params.spatialRel = 'esriSpatialRelOverlaps';\n    return this;\n  },\n\n  // only valid for Feature Services running on ArcGIS Server 10.3 or ArcGIS Online\n  nearby: function(latlng, radius){\n    latlng = L.latLng(latlng);\n    this.params.geometry = ([latlng.lng,latlng.lat]).join(',');\n    this.params.geometryType = 'esriGeometryPoint';\n    this.params.spatialRel = 'esriSpatialRelIntersects';\n    this.params.units = 'esriSRUnit_Meter';\n    this.params.distance = radius;\n    this.params.inSr = 4326;\n    return this;\n  },\n\n  where: function(string){\n    this.params.where = string.replace(/\"/g, \"\\'\"); // jshint ignore:line\n    return this;\n  },\n\n  between: function(start, end){\n    this.params.time = ([start.valueOf(), end.valueOf()]).join();\n    return this;\n  },\n\n  fields: function (fields) {\n    if (L.Util.isArray(fields)) {\n      this.params.outFields = fields.join(',');\n    } else {\n      this.params.outFields = fields;\n    }\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * factor;\n    return this;\n  },\n\n  orderBy: function(fieldName, order){\n    order = order || 'ASC';\n    this.params.orderByFields = (this.params.orderByFields) ? this.params.orderByFields + ',' : '';\n    this.params.orderByFields += ([fieldName, order]).join(' ');\n    return this;\n  },\n\n  returnGeometry: function(bool){\n    this.params.returnGeometry = bool;\n    return this;\n  },\n\n  run: function(callback, context){\n    this._cleanParams();\n    return this.request(function(error, response){\n      callback.call(context, error, (response && EsriLeaflet.Util.responseToFeatureCollection(response)), response);\n    }, context);\n  },\n\n  count: function(callback, context){\n    this._cleanParams();\n    this.params.returnCountOnly = true;\n    return this.request(function(error, response){\n      callback.call(this, error, (response && response.count), response);\n    }, context);\n  },\n\n  ids: function(callback, context){\n    this._cleanParams();\n    this.params.returnIdsOnly = true;\n    return this.request(function(error, response){\n      callback.call(this, error, (response && response.objectIds), response);\n    }, context);\n  },\n\n  // only valid for Feature Services running on ArcGIS Server 10.3 or ArcGIS Online\n  bounds: function(callback, context){\n    this._cleanParams();\n    this.params.returnExtentOnly = true;\n    return this.request(function(error, response){\n      callback.call(context, error, (response && response.extent && EsriLeaflet.Util.extentToBounds(response.extent)), response);\n    }, context);\n  },\n\n  // only valid for image services\n  pixelSize: function(point){\n    point = L.point(point);\n    this.params.pixelSize = ([point.x,point.y]).join(',');\n    return this;\n  },\n\n  // only valid for map services\n  layer: function(layer){\n    this.path = layer + '/query';\n    return this;\n  },\n\n  _cleanParams: function(){\n    delete this.params.returnIdsOnly;\n    delete this.params.returnExtentOnly;\n    delete this.params.returnCountOnly;\n  },\n\n  _setGeometry: function(geometry) {\n    this.params.inSr = 4326;\n\n    // convert bounds to extent and finish\n    if ( geometry instanceof L.LatLngBounds ) {\n      // set geometry + geometryType\n      this.params.geometry = EsriLeaflet.Util.boundsToExtent(geometry);\n      this.params.geometryType = 'esriGeometryEnvelope';\n      return;\n    }\n\n    // convert L.Marker > L.LatLng\n    if(geometry.getLatLng){\n      geometry = geometry.getLatLng();\n    }\n\n    // convert L.LatLng to a geojson point and continue;\n    if (geometry instanceof L.LatLng) {\n      geometry = {\n        type: 'Point',\n        coordinates: [geometry.lng, geometry.lat]\n      };\n    }\n\n    // handle L.GeoJSON, pull out the first geometry\n    if ( geometry instanceof L.GeoJSON ) {\n      //reassign geometry to the GeoJSON value  (we are assuming that only one feature is present)\n      geometry = geometry.getLayers()[0].feature.geometry;\n      this.params.geometry = EsriLeaflet.Util.geojsonToArcGIS(geometry);\n      this.params.geometryType = EsriLeaflet.Util.geojsonTypeToArcGIS(geometry.type);\n    }\n\n    // Handle L.Polyline and L.Polygon\n    if (geometry.toGeoJSON) {\n      geometry = geometry.toGeoJSON();\n    }\n\n    // handle GeoJSON feature by pulling out the geometry\n    if ( geometry.type === 'Feature' ) {\n      // get the geometry of the geojson feature\n      geometry = geometry.geometry;\n    }\n\n    // confirm that our GeoJSON is a point, line or polygon\n    if ( geometry.type === 'Point' ||  geometry.type === 'LineString' || geometry.type === 'Polygon') {\n      this.params.geometry = EsriLeaflet.Util.geojsonToArcGIS(geometry);\n      this.params.geometryType = EsriLeaflet.Util.geojsonTypeToArcGIS(geometry.type);\n      return;\n    }\n\n    // warn the user if we havn't found a\n    /* global console */\n    if(console && console.warn) {\n      console.warn('invalid geometry passed to spatial query. Should be an L.LatLng, L.LatLngBounds or L.Marker or a GeoJSON Point Line or Polygon object');\n    }\n\n    return;\n  }\n});\n\nEsriLeaflet.Tasks.query = function(url, params){\n  return new EsriLeaflet.Tasks.Query(url, params);\n};","EsriLeaflet.Tasks.Find = EsriLeaflet.Tasks.Task.extend({\n  setters: {\n    // method name > param name\n    'contains': 'contains',\n    'text': 'searchText',\n    'fields': 'searchFields[]', // denote an array or single string\n    'spatialReference': 'sr',\n    'sr': 'sr',\n    'layers': 'layers[]',\n    'returnGeometry': 'returnGeometry',\n    'maxAllowableOffset': 'maxAllowableOffset',\n    'precision': 'geometryPrecision',\n    'dynamicLayers': 'dynamicLayers',\n    'returnZ' : 'returnZ',\n    'returnM' : 'returnM',\n    'gdbVersion' : 'gdbVersion',\n    'token' : 'token'\n  },\n\n  path: 'find',\n\n  params: {\n    sr: 4326,\n    contains: true,\n    returnGeometry: true,\n    returnZ: true,\n    returnM: false\n  },\n\n  layerDefs: function (id, where) {\n    this.params.layerDefs = (this.params.layerDefs) ? this.params.layerDefs + ';' : '';\n    this.params.layerDefs += ([id, where]).join(':');\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * factor;\n    return this;\n  },\n\n  run: function (callback, context) {\n    return this.request(function(error, response){\n      callback.call(context, error, (response && EsriLeaflet.Util.responseToFeatureCollection(response)), response);\n    }, context);\n  }\n});\n\nEsriLeaflet.Tasks.find = function (url, params) {\n  return new EsriLeaflet.Tasks.Find(url, params);\n};","EsriLeaflet.Tasks.Identify = EsriLeaflet.Tasks.Task.extend({\n  path: 'identify',\n\n  between: function(start, end){\n    this.params.time = ([start.valueOf(), end.valueOf()]).join(',');\n    return this;\n  },\n\n  returnGeometry: function (returnGeometry) {\n    this.params.returnGeometry = returnGeometry;\n    return this;\n  }\n});\n","EsriLeaflet.Tasks.IdentifyImage = EsriLeaflet.Tasks.Identify.extend({\n  setters: {\n    'setMosaicRule': 'mosaicRule',\n    'setRenderingRule': 'renderingRule',\n    'returnCatalogItems': 'returnCatalogItems'\n  },\n\n  params: {\n    returnGeometry: false\n  },\n\n  at: function(latlng){\n    latlng = L.latLng(latlng);\n    this.params.geometry = JSON.stringify({\n      x: latlng.lng,\n      y: latlng.lat,\n      spatialReference:{\n        wkid: 4326\n      }\n    });\n    this.params.geometryType = 'esriGeometryPoint';\n    return this;\n  },\n\n  getMosaicRule: function() {\n    return this.params.mosaicRule;\n  },\n\n  getRenderingRule: function() {\n    return this.params.renderingRule;\n  },\n\n  setPixelSize: function(pixelSize) {\n    this.params.pixelSize = pixelSize.join ? pixelSize.join(',') : pixelSize;\n    return this;\n  },\n\n  getPixelSize: function() {\n    return this.params.pixelSize;\n  },\n\n  run: function (callback, context){\n    return this.request(function(error, response){\n      callback.call(context, error, (response && this._responseToGeoJSON(response)), response);\n    }, this);\n  },\n\n  // get pixel data and return as geoJSON point\n  // populate catalog items (if any)\n  // merging in any catalogItemVisibilities as a propery of each feature\n  _responseToGeoJSON: function(response) {\n    var location = response.location;\n    var catalogItems = response.catalogItems;\n    var catalogItemVisibilities = response.catalogItemVisibilities;\n    var geoJSON =  {\n      'pixel': {\n        'type': 'Feature',\n        'geometry': {\n          'type': 'Point',\n          'coordinates': [location.x, location.y]\n        },\n        'crs': {\n          'type': 'EPSG',\n          'properties': {\n            'code': location.spatialReference.wkid\n          }\n        },\n        'properties': {\n          'OBJECTID': response.objectId,\n          'name': response.name,\n          'value': response.value\n        },\n        'id': response.objectId\n      }\n    };\n\n    if (response.properties && response.properties.Values) {\n      geoJSON.pixel.properties.values = response.properties.Values;\n    }\n\n    if (catalogItems && catalogItems.features) {\n      geoJSON.catalogItems = EsriLeaflet.Util.responseToFeatureCollection(catalogItems);\n      if (catalogItemVisibilities && catalogItemVisibilities.length === geoJSON.catalogItems.features.length) {\n        for (var i = catalogItemVisibilities.length - 1; i >= 0; i--) {\n          geoJSON.catalogItems.features[i].properties.catalogItemVisibility = catalogItemVisibilities[i];\n        }\n      }\n    }\n    return geoJSON;\n  }\n\n});\n\nEsriLeaflet.Tasks.identifyImage = function(url, params){\n  return new EsriLeaflet.Tasks.IdentifyImage(url, params);\n};","EsriLeaflet.Tasks.IdentifyFeatures = EsriLeaflet.Tasks.Identify.extend({\n  setters: {\n    'layers': 'layers',\n    'precision': 'geometryPrecision',\n    'tolerance': 'tolerance'\n  },\n\n  params: {\n    sr: 4326,\n    layers: 'all',\n    tolerance: 3,\n    returnGeometry: true\n  },\n\n  on: function(map){\n    var extent = EsriLeaflet.Util.boundsToExtent(map.getBounds());\n    var size = map.getSize();\n    this.params.imageDisplay = [size.x, size.y, 96].join(',');\n    this.params.mapExtent=([extent.xmin, extent.ymin, extent.xmax, extent.ymax]).join(',');\n    return this;\n  },\n\n  at: function(latlng){\n    latlng = L.latLng(latlng);\n    this.params.geometry = ([latlng.lng, latlng.lat]).join(',');\n    this.params.geometryType = 'esriGeometryPoint';\n    return this;\n  },\n\n  layerDef: function (id, where){\n    this.params.layerDefs = (this.params.layerDefs) ? this.params.layerDefs + ';' : '';\n    this.params.layerDefs += ([id, where]).join(':');\n    return this;\n  },\n\n  simplify: function(map, factor){\n    var mapWidth = Math.abs(map.getBounds().getWest() - map.getBounds().getEast());\n    this.params.maxAllowableOffset = (mapWidth / map.getSize().y) * (1 - factor);\n    return this;\n  },\n\n  run: function (callback, context){\n    return this.request(function(error, response){\n      callback.call(context, error, (response && EsriLeaflet.Util.responseToFeatureCollection(response)), response);\n    }, context);\n  }\n\n});\n\nEsriLeaflet.Tasks.identifyFeatures = function(url, params){\n  return new EsriLeaflet.Tasks.IdentifyFeatures(url, params);\n};","(function(EsriLeaflet){\n\n  var tileProtocol = (window.location.protocol !== 'https:') ? 'http:' : 'https:';\n\n  EsriLeaflet.Layers.BasemapLayer = L.TileLayer.extend({\n    statics: {\n      TILES: {\n        Streets: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',\n          attributionUrl: 'https://static.arcgis.com/attribution/World_Street_Map',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 19,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri'\n          }\n        },\n        Topographic: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',\n          attributionUrl: 'https://static.arcgis.com/attribution/World_Topo_Map',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 19,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri'\n          }\n        },\n        Oceans: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',\n          attributionUrl: 'https://static.arcgis.com/attribution/Ocean_Basemap',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 16,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri'\n          }\n        },\n        OceansLabels: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 16,\n            subdomains: ['server', 'services']\n          }\n        },\n        NationalGeographic: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 16,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri'\n          }\n        },\n        DarkGray: {\n          urlTemplate: tileProtocol + '//tiles{s}.arcgis.com/tiles/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Dark_Gray_Base_Beta/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 10,\n            subdomains: ['1', '2'],\n            attribution: 'Esri, DeLorme, HERE'\n          }\n        },\n        DarkGrayLabels: {\n          urlTemplate: tileProtocol + '//tiles{s}.arcgis.com/tiles/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Dark_Gray_Reference_Beta/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 10,\n            subdomains: ['1', '2']\n          }\n        },\n        Gray: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 16,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri, NAVTEQ, DeLorme'\n          }\n        },\n        GrayLabels: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 16,\n            subdomains: ['server', 'services']\n          }\n        },\n        Imagery: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 19,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community'\n          }\n        },\n        ImageryLabels: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 19,\n            subdomains: ['server', 'services']\n          }\n        },\n        ImageryTransportation: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 19,\n            subdomains: ['server', 'services']\n          }\n        },\n        ShadedRelief: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 13,\n            subdomains: ['server', 'services'],\n            attribution: 'ESRI, NAVTEQ, DeLorme'\n          }\n        },\n        ShadedReliefLabels: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places_Alternate/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 12,\n            subdomains: ['server', 'services']\n          }\n        },\n        Terrain: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: false,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 13,\n            subdomains: ['server', 'services'],\n            attribution: 'Esri, USGS, NOAA'\n          }\n        },\n        TerrainLabels: {\n          urlTemplate: tileProtocol + '//{s}.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer/tile/{z}/{y}/{x}',\n          options: {\n            hideLogo: true,\n            logoPosition: 'bottomright',\n            minZoom: 1,\n            maxZoom: 13,\n            subdomains: ['server', 'services']\n          }\n        }\n      }\n    },\n    initialize: function(key, options){\n      var config;\n\n      // set the config variable with the appropriate config object\n      if (typeof key === 'object' && key.urlTemplate && key.options){\n        config = key;\n      } else if(typeof key === 'string' && EsriLeaflet.BasemapLayer.TILES[key]){\n        config = EsriLeaflet.BasemapLayer.TILES[key];\n      } else {\n        throw new Error('L.esri.BasemapLayer: Invalid parameter. Use one of \"Streets\", \"Topographic\", \"Oceans\", \"OceansLabels\", \"NationalGeographic\", \"Gray\", \"GrayLabels\", \"DarkGray\", \"DarkGrayLabels\", \"Imagery\", \"ImageryLabels\", \"ImageryTransportation\", \"ShadedRelief\", \"ShadedReliefLabels\", \"Terrain\" or \"TerrainLabels\"');\n      }\n\n      // merge passed options into the config options\n      var tileOptions = L.Util.extend(config.options, options);\n\n      // call the initialize method on L.TileLayer to set everything up\n      L.TileLayer.prototype.initialize.call(this, config.urlTemplate, L.Util.setOptions(this, tileOptions));\n\n      // if this basemap requires dynamic attribution set it up\n      if(config.attributionUrl){\n        this._getAttributionData(config.attributionUrl);\n      }\n    },\n    onAdd: function(map){\n      if(!this.options.hideLogo){\n        this._logo = new EsriLeaflet.Controls.Logo({\n          position: this.options.logoPosition\n        }).addTo(map);\n      }\n\n      L.TileLayer.prototype.onAdd.call(this, map);\n\n      map.on('moveend', this._updateMapAttribution, this);\n    },\n    onRemove: function(map){\n      if(this._logo){\n        map.removeControl(this._logo);\n      }\n\n      L.TileLayer.prototype.onRemove.call(this, map);\n\n      map.off('moveend', this._updateMapAttribution, this);\n    },\n    getAttribution:function(){\n      var attribution = '<span class=\"esri-attributions\" style=\"line-height:14px; vertical-align: -3px; text-overflow:ellipsis; white-space:nowrap; overflow:hidden; display:inline-block;\">' + this.options.attribution + '</span>'/* + logo*/;\n      return attribution;\n    },\n    _getAttributionData: function(url){\n      EsriLeaflet.get(url, {}, function(error, attributions){\n        this._attributions = [];\n        for (var c = 0; c < attributions.contributors.length; c++) {\n          var contributor = attributions.contributors[c];\n          for (var i = 0; i < contributor.coverageAreas.length; i++) {\n            var coverageArea = contributor.coverageAreas[i];\n            var southWest = new L.LatLng(coverageArea.bbox[0], coverageArea.bbox[1]);\n            var northEast = new L.LatLng(coverageArea.bbox[2], coverageArea.bbox[3]);\n            this._attributions.push({\n              attribution: contributor.attribution,\n              score: coverageArea.score,\n              bounds: new L.LatLngBounds(southWest, northEast),\n              minZoom: coverageArea.zoomMin,\n              maxZoom: coverageArea.zoomMax\n            });\n          }\n        }\n\n        this._attributions.sort(function(a, b){\n          return b.score - a.score;\n        });\n\n        this._updateMapAttribution();\n      }, this);\n    },\n    _updateMapAttribution: function(){\n      if(this._map && this._map.attributionControl && this._attributions){\n        var newAttributions = '';\n        var bounds = this._map.getBounds();\n        var zoom = this._map.getZoom();\n\n        for (var i = 0; i < this._attributions.length; i++) {\n          var attribution = this._attributions[i];\n          var text = attribution.attribution;\n          if(!newAttributions.match(text) && bounds.intersects(attribution.bounds) && zoom >= attribution.minZoom && zoom <= attribution.maxZoom) {\n            newAttributions += (', ' + text);\n          }\n        }\n        newAttributions = newAttributions.substr(2);\n        var attributionElement = this._map.attributionControl._container.querySelector('.esri-attributions');\n\n        attributionElement.innerHTML = newAttributions;\n        attributionElement.style.maxWidth =  (this._map.getSize().x * 0.65) + 'px';\n\n        this.fire('attributionupdated', {\n          attribution: newAttributions\n        });\n      }\n    }\n  });\n\n  EsriLeaflet.BasemapLayer = EsriLeaflet.Layers.BasemapLayer;\n\n  EsriLeaflet.Layers.basemapLayer = function(key, options){\n    return new EsriLeaflet.Layers.BasemapLayer(key, options);\n  };\n\n  EsriLeaflet.basemapLayer = function(key, options){\n    return new EsriLeaflet.Layers.BasemapLayer(key, options);\n  };\n\n})(EsriLeaflet);","EsriLeaflet.Layers.RasterLayer =  L.Layer.extend({\n\n  options: {\n    opacity: 1,\n    position: 'front',\n    f: 'image'\n  },\n\n  onAdd: function (map) {\n    this._map = map;\n\n    this._update = L.Util.throttle(this._update, this.options.updateInterval, this);\n\n    if (map.options.crs && map.options.crs.code) {\n      var sr = map.options.crs.code.split(':')[1];\n      this.options.bboxSR = sr;\n      this.options.imageSR = sr;\n    }\n\n    this._update();\n\n    if(this._popup){\n      this._map.on('click', this._getPopupData, this);\n      this._map.on('dblclick', this._resetPopupState, this);\n    }\n  },\n\n  bindPopup: function(fn, popupOptions){\n    this._shouldRenderPopup = false;\n    this._lastClick = false;\n    this._popup = L.popup(popupOptions);\n    this._popupFunction = fn;\n    if(this._map){\n      this._map.on('click', this._getPopupData, this);\n      this._map.on('dblclick', this._resetPopupState, this);\n    }\n    return this;\n  },\n\n  unbindPopup: function(){\n    if(this._map){\n      this._map.closePopup(this._popup);\n      this._map.off('click', this._getPopupData, this);\n      this._map.off('dblclick', this._resetPopupState, this);\n    }\n    this._popup = false;\n    return this;\n  },\n\n  onRemove: function () {\n    if (this._currentImage) {\n      this._map.removeLayer(this._currentImage);\n    }\n\n    if(this._popup){\n      this._map.off('click', this._getPopupData, this);\n      this._map.off('dblclick', this._resetPopupState, this);\n    }\n\n    // @TODO remove at Leaflet 0.8\n    this._map.removeEventListener(this.getEvents(), this);\n  },\n\n  getEvents: function(){\n    return {\n      moveend: this._update\n    };\n  },\n\n  bringToFront: function(){\n    this.options.position = 'front';\n    if(this._currentImage){\n      this._currentImage.bringToFront();\n    }\n    return this;\n  },\n\n  bringToBack: function(){\n    this.options.position = 'back';\n    if(this._currentImage){\n      this._currentImage.bringToBack();\n    }\n    return this;\n  },\n\n  getAttribution: function () {\n    return this.options.attribution;\n  },\n\n  getOpacity: function(){\n    return this.options.opacity;\n  },\n\n  setOpacity: function(opacity){\n    this.options.opacity = opacity;\n    this._currentImage.setOpacity(opacity);\n    return this;\n  },\n\n  getTimeRange: function(){\n    return [this.options.from, this.options.to];\n  },\n\n  setTimeRange: function(from, to){\n    this.options.from = from;\n    this.options.to = to;\n    this._update();\n    return this;\n  },\n\n  metadata: function(callback, context){\n    this._service.metadata(callback, context);\n    return this;\n  },\n\n  authenticate: function(token){\n    this._service.authenticate(token);\n    return this;\n  },\n\n  _renderImage: function(url, bounds){\n    var image = new L.ImageOverlay(url, bounds, {\n      opacity: 0\n    }).addTo(this._map);\n\n    image.once('load', function(e){\n      var newImage = e.target;\n      var oldImage = this._currentImage;\n\n      if(newImage._bounds.equals(bounds)){\n        this._currentImage = newImage;\n\n        if(this.options.position === 'front'){\n          this.bringToFront();\n        } else {\n          this.bringToBack();\n        }\n\n        this._currentImage.setOpacity(this.options.opacity);\n\n        if(oldImage){\n          this._map.removeLayer(oldImage);\n        }\n      } else {\n        this._map.removeLayer(newImage);\n      }\n\n      this.fire('load', {\n        bounds: bounds\n      });\n\n    }, this);\n\n    this.fire('loading', {\n      bounds: bounds\n    });\n  },\n\n  _update: function () {\n    if(!this._map){\n      return;\n    }\n\n    var zoom = this._map.getZoom();\n    var bounds = this._map.getBounds();\n\n    if(this._animatingZoom){\n      return;\n    }\n\n    if (this._map._panTransition && this._map._panTransition._inProgress) {\n      return;\n    }\n\n    if (zoom > this.options.maxZoom || zoom < this.options.minZoom) {\n      return;\n    }\n    var params = this._buildExportParams();\n    this._requestExport(params, bounds);\n  },\n\n  // TODO: refactor these into raster layer\n  _renderPopup: function(latlng, error, results, response){\n    latlng = L.latLng(latlng);\n    if(this._shouldRenderPopup && this._lastClick.equals(latlng)){\n      //add the popup to the map where the mouse was clicked at\n      var content = this._popupFunction(error, results, response);\n      if (content) {\n        this._popup.setLatLng(latlng).setContent(content).openOn(this._map);\n      }\n    }\n  },\n\n  _resetPopupState: function(e){\n    this._shouldRenderPopup = false;\n    this._lastClick = e.latlng;\n  }\n});","EsriLeaflet.Layers.DynamicMapLayer = EsriLeaflet.Layers.RasterLayer.extend({\n\n  options: {\n    updateInterval: 150,\n    layers: false,\n    layerDefs: false,\n    timeOptions: false,\n    format: 'png24',\n    transparent: true\n  },\n\n  initialize: function (url, options) {\n    this.url = EsriLeaflet.Util.cleanUrl(url);\n    this._service = new EsriLeaflet.Services.MapService(this.url, options);\n    this._service.addEventParent(this);\n    L.Util.setOptions(this, options);\n  },\n\n  getLayers: function(){\n    return this.options.layers;\n  },\n\n  setLayers: function(layers){\n    this.options.layers = layers;\n    this._update();\n    return this;\n  },\n\n  getLayerDefs: function(){\n    return this.options.layerDefs;\n  },\n\n  setLayerDefs: function(layerDefs){\n    this.options.layerDefs = layerDefs;\n    this._update();\n    return this;\n  },\n\n  getTimeOptions: function(){\n    return this.options.timeOptions;\n  },\n\n  setTimeOptions: function(timeOptions){\n    this.options.timeOptions = timeOptions;\n    this._update();\n    return this;\n  },\n\n  query: function(){\n    return this._service.query();\n  },\n\n  identify: function(){\n    return this._service.identify();\n  },\n\n  find: function(){\n    return this._service.find();\n  },\n\n  _getPopupData: function(e){\n    var callback = L.Util.bind(function(error, featureCollection, response) {\n      setTimeout(L.Util.bind(function(){\n        this._renderPopup(e.latlng, error, featureCollection, response);\n      }, this), 300);\n    }, this);\n\n    var identifyRequest = this.identify().on(this._map).at(e.latlng);\n\n    if(this.options.layers){\n      identifyRequest.layers('visible:' + this.options.layers.join(','));\n    } else {\n      identifyRequest.layers('visible');\n    }\n\n    identifyRequest.run(callback);\n\n    // set the flags to show the popup\n    this._shouldRenderPopup = true;\n    this._lastClick = e.latlng;\n  },\n\n  _buildExportParams: function () {\n    var bounds = this._map.getBounds();\n    var size = this._map.getSize();\n    var ne = this._map.options.crs.project(bounds._northEast);\n    var sw = this._map.options.crs.project(bounds._southWest);\n\n    var params = {\n      bbox: [sw.x, sw.y, ne.x, ne.y].join(','),\n      size: size.x + ',' + size.y,\n      dpi: 96,\n      format: this.options.format,\n      transparent: this.options.transparent,\n      bboxSR: this.options.bboxSR,\n      imageSR: this.options.imageSR\n    };\n\n    if(this.options.layers){\n      params.layers = 'show:' + this.options.layers.join(',');\n    }\n\n    if(this.options.layerDefs){\n      params.layerDefs = JSON.stringify(this.options.layerDefs);\n    }\n\n    if(this.options.timeOptions){\n      params.timeOptions = JSON.stringify(this.options.timeOptions);\n    }\n\n    if(this.options.from && this.options.to){\n      params.time = this.options.from.valueOf() + ',' + this.options.to.valueOf();\n    }\n\n    if(this._service.options.token) {\n      params.token = this._service.options.token;\n    }\n\n    return params;\n  },\n\n  _requestExport: function (params, bounds) {\n    if(this.options.f === 'json'){\n      this._service.get('export', params, function(error, response){\n        this._renderImage(response.href, bounds);\n      }, this);\n    } else {\n      params.f = 'image';\n      this._renderImage(this.url + 'export' + L.Util.getParamString(params), bounds);\n    }\n  }\n});\n\nEsriLeaflet.DynamicMapLayer = EsriLeaflet.Layers.DynamicMapLayer;\n\nEsriLeaflet.Layers.dynamicMapLayer = function(url, options){\n  return new EsriLeaflet.Layers.DynamicMapLayer(url, options);\n};\n\nEsriLeaflet.dynamicMapLayer = function(url, options){\n  return new EsriLeaflet.Layers.DynamicMapLayer(url, options);\n};","EsriLeaflet.Layers.ImageMapLayer = EsriLeaflet.Layers.RasterLayer.extend({\n\n  options: {\n    updateInterval: 150,\n    format: 'jpgpng'\n  },\n\n  query: function(){\n    return this._service.query();\n  },\n\n  identify: function(){\n    return this._service.identify();\n  },\n\n  initialize: function (url, options) {\n    this.url = EsriLeaflet.Util.cleanUrl(url);\n    this._service = new EsriLeaflet.Services.ImageService(this.url, options);\n    this._service.addEventParent(this);\n    L.Util.setOptions(this, options);\n  },\n\n  setPixelType: function (pixelType) {\n    this.options.pixelType = pixelType;\n    this._update();\n    return this;\n  },\n\n  getPixelType: function () {\n    return this.options.pixelType;\n  },\n\n  setBandIds: function (bandIds) {\n    if (L.Util.isArray(bandIds)) {\n      this.options.bandIds = bandIds.join(',');\n    } else {\n      this.options.bandIds = bandIds.toString();\n    }\n    this._update();\n    return this;\n  },\n\n  getBandIds: function () {\n    return this.options.bandIds;\n  },\n\n  setNoData: function (noData, noDataInterpretation) {\n    if (L.Util.isArray(noData)) {\n      this.options.noData = noData.join(',');\n    } else {\n      this.options.noData = noData.toString();\n    }\n    if (noDataInterpretation) {\n      this.options.noDataInterpretation = noDataInterpretation;\n    }\n    this._update();\n    return this;\n  },\n\n  getNoData: function () {\n    return this.options.noData;\n  },\n\n  getNoDataInterpretation: function () {\n    return this.options.noDataInterpretation;\n  },\n\n  setRenderingRule: function(renderingRule) {\n    this.options.renderingRule = renderingRule;\n    this._update();\n  },\n\n  getRenderingRule: function() {\n    return this.options.renderingRule;\n  },\n\n  setMosaicRule: function(mosaicRule) {\n    this.options.mosaicRule = mosaicRule;\n    this._update();\n  },\n\n  getMosaicRule: function() {\n    return this.options.mosaicRule;\n  },\n\n  _getPopupData: function(e){\n    var callback = L.Util.bind(function(error, results, response) {\n      setTimeout(L.Util.bind(function(){\n        this._renderPopup(e.latlng, error, results, response);\n      }, this), 300);\n    }, this);\n\n    var identifyRequest = this.identify().at(e.latlng);\n\n    // set mosaic rule for identify task if it is set for layer\n    if (this.options.mosaicRule) {\n      identifyRequest.setMosaicRule(this.options.mosaicRule);\n      // @TODO: force return catalog items too?\n    }\n\n    // @TODO: set rendering rule? Not sure,\n    // sometimes you want raw pixel values\n    // if (this.options.renderingRule) {\n    //   identifyRequest.setRenderingRule(this.options.renderingRule);\n    // }\n\n    identifyRequest.run(callback);\n\n    // set the flags to show the popup\n    this._shouldRenderPopup = true;\n    this._lastClick = e.latlng;\n  },\n\n  _buildExportParams: function () {\n    var bounds = this._map.getBounds();\n    var size = this._map.getSize();\n    var ne = this._map.options.crs.project(bounds._northEast);\n    var sw = this._map.options.crs.project(bounds._southWest);\n\n    var params = {\n      bbox: [sw.x, sw.y, ne.x, ne.y].join(','),\n      size: size.x + ',' + size.y,\n      format: this.options.format,\n      bboxSR: this.options.bboxSR,\n      imageSR: this.options.imageSR\n    };\n\n    if (this.options.from && this.options.to) {\n      params.time = this.options.from.valueOf() + ',' + this.options.to.valueOf();\n    }\n\n    if (this.options.pixelType) {\n      params.pixelType = this.options.pixelType;\n    }\n\n    if (this.options.interpolation) {\n      params.interpolation = this.options.interpolation;\n    }\n\n    if (this.options.compressionQuality) {\n      params.compressionQuality = this.options.compressionQuality;\n    }\n\n    if (this.options.bandIds) {\n      params.bandIds = this.options.bandIds;\n    }\n\n    if (this.options.noData) {\n      params.noData = this.options.noData;\n    }\n\n    if (this.options.noDataInterpretation) {\n      params.noDataInterpretation = this.options.noDataInterpretation;\n    }\n\n    if (this._service.options.token) {\n      params.token = this._service.options.token;\n    }\n\n    if(this.options.renderingRule) {\n      params.renderingRule = JSON.stringify(this.options.renderingRule);\n    }\n\n    if(this.options.mosaicRule) {\n      params.mosaicRule = JSON.stringify(this.options.mosaicRule);\n    }\n\n    return params;\n  },\n\n  _requestExport: function (params, bounds) {\n    if (this.options.f === 'json') {\n      this._service.get('exportImage', params, function(error, response){\n        this._renderImage(response.href, bounds);\n      }, this);\n    } else {\n      params.f = 'image';\n      this._renderImage(this.url + 'exportImage' + L.Util.getParamString(params), bounds);\n    }\n  }\n});\n\nEsriLeaflet.ImageMapLayer = EsriLeaflet.Layers.ImageMapLayer;\n\nEsriLeaflet.Layers.imageMapLayer = function (url, options) {\n  return new EsriLeaflet.Layers.ImageMapLayer(url, options);\n};\n\nEsriLeaflet.imageMapLayer = function (url, options) {\n  return new EsriLeaflet.Layers.ImageMapLayer(url, options);\n};","EsriLeaflet.Layers.TiledMapLayer = L.TileLayer.extend({\n  initialize: function(url, options){\n    options = L.Util.setOptions(this, options);\n\n    // set the urls\n    this.url = L.esri.Util.cleanUrl(url);\n    this.tileUrl = L.esri.Util.cleanUrl(url) + 'tile/{z}/{y}/{x}';\n    this._service = new L.esri.Services.MapService(this.url, options);\n    this._service.addEventParent(this);\n\n    //if this is looking at the AGO tiles subdomain insert the subdomain placeholder\n    if(this.tileUrl.match('://tiles.arcgisonline.com')){\n      this.tileUrl = this.tileUrl.replace('://tiles.arcgisonline.com', '://tiles{s}.arcgisonline.com');\n      options.subdomains = ['1', '2', '3', '4'];\n    }\n\n    // init layer by calling TileLayers initialize method\n    L.TileLayer.prototype.initialize.call(this, this.tileUrl, options);\n  },\n\n  metadata: function(callback, context){\n    this._service.metadata(callback, context);\n    return this;\n  },\n\n  identify: function(){\n    return this._service.identify();\n  },\n\n  authenticate: function(token){\n    this._service.authenticate(token);\n    return this;\n  }\n});\n\nL.esri.TiledMapLayer = L.esri.Layers.tiledMapLayer;\n\nL.esri.Layers.tiledMapLayer = function(url, options){\n  return new L.esri.Layers.TiledMapLayer(url, options);\n};\n\nL.esri.tiledMapLayer = function(url, options){\n  return new L.esri.Layers.TiledMapLayer(url, options);\n};","EsriLeaflet.Layers.FeatureGrid = L.Layer.extend({\n\n  options: {\n    cellSize: 512,\n    updateInterval: 150\n  },\n\n  initialize: function (options) {\n    options = L.setOptions(this, options);\n  },\n\n  onAdd: function (map) {\n    this._map = map;\n    this._update = L.Util.throttle(this._update, this.options.updateInterval, this);\n\n    this._reset();\n    this._update();\n  },\n\n  onRemove: function(){\n    this._map.removeEventListener(this.getEvents(), this);\n    this._removeCells();\n  },\n\n  getEvents: function () {\n    var events = {\n      viewreset: this._reset,\n      moveend: this._update\n    };\n\n    return events;\n  },\n\n  addTo: function(map){\n    map.addLayer(this);\n    return this;\n  },\n\n  removeFrom: function(map){\n    map.removeLayer(this);\n    return this;\n  },\n\n  _reset: function () {\n    this._removeCells();\n\n    this._cells = {};\n    this._activeCells = {};\n    this._cellsToLoad = 0;\n    this._cellsTotal = 0;\n\n    this._cellNumBounds = this._getCellNumBounds();\n\n    this._resetWrap();\n  },\n\n  _resetWrap: function () {\n    var map = this._map,\n        crs = map.options.crs;\n\n    if (crs.infinite) { return; }\n\n    var cellSize = this._getCellSize();\n\n    if (crs.wrapLng) {\n      this._wrapLng = [\n        Math.floor(map.project([0, crs.wrapLng[0]]).x / cellSize),\n        Math.ceil(map.project([0, crs.wrapLng[1]]).x / cellSize)\n      ];\n    }\n\n    if (crs.wrapLat) {\n      this._wrapLat = [\n        Math.floor(map.project([crs.wrapLat[0], 0]).y / cellSize),\n        Math.ceil(map.project([crs.wrapLat[1], 0]).y / cellSize)\n      ];\n    }\n  },\n\n  _getCellSize: function () {\n    return this.options.cellSize;\n  },\n\n  _update: function () {\n    if (!this._map) { return; }\n\n    var bounds = this._map.getPixelBounds(),\n        zoom = this._map.getZoom(),\n        cellSize = this._getCellSize();\n\n    if (zoom > this.options.maxZoom ||\n        zoom < this.options.minZoom) { return; }\n\n    // cell coordinates range for the current view\n    var cellBounds = L.bounds(\n      bounds.min.divideBy(cellSize).floor(),\n      bounds.max.divideBy(cellSize).floor());\n\n    this._addCells(cellBounds);\n    this._removeOtherCells(cellBounds);\n  },\n\n  _addCells: function (bounds) {\n    var queue = [],\n        center = bounds.getCenter(),\n        zoom = this._map.getZoom();\n\n    var j, i, coords;\n    // create a queue of coordinates to load cells from\n    for (j = bounds.min.y; j <= bounds.max.y; j++) {\n      for (i = bounds.min.x; i <= bounds.max.x; i++) {\n        coords = new L.Point(i, j);\n        coords.z = zoom;\n\n        // @TODO enable at Leaflet 0.8\n        // if (this._isValidCell(coords)) {\n        //   queue.push(coords);\n        // }\n\n        queue.push(coords);\n      }\n    }\n    var cellsToLoad = queue.length;\n\n    if (cellsToLoad === 0) { return; }\n\n    this._cellsToLoad += cellsToLoad;\n    this._cellsTotal += cellsToLoad;\n\n    // sort cell queue to load cells in order of their distance to center\n    queue.sort(function (a, b) {\n      return a.distanceTo(center) - b.distanceTo(center);\n    });\n\n    for (i = 0; i < cellsToLoad; i++) {\n      this._addCell(queue[i]);\n    }\n  },\n\n  // @TODO enable at Leaflet 0.8\n  // _isValidCell: function (coords) {\n  //   var crs = this._map.options.crs;\n\n  //   if (!crs.infinite) {\n  //     // don't load cell if it's out of bounds and not wrapped\n  //     var bounds = this._cellNumBounds;\n  //     if (\n  //       (!crs.wrapLng && (coords.x < bounds.min.x || coords.x > bounds.max.x)) ||\n  //       (!crs.wrapLat && (coords.y < bounds.min.y || coords.y > bounds.max.y))\n  //     ) {\n  //       return false;\n  //     }\n  //   }\n\n  //   if (!this.options.bounds) {\n  //     return true;\n  //   }\n\n  //   // don't load cell if it doesn't intersect the bounds in options\n  //   var cellBounds = this._cellCoordsToBounds(coords);\n  //   return L.latLngBounds(this.options.bounds).intersects(cellBounds);\n  // },\n\n  // converts cell coordinates to its geographical bounds\n  _cellCoordsToBounds: function (coords) {\n    var map = this._map,\n        cellSize = this.options.cellSize,\n\n        nwPoint = coords.multiplyBy(cellSize),\n        sePoint = nwPoint.add([cellSize, cellSize]),\n\n        // @TODO for Leaflet 0.8\n        // nw = map.wrapLatLng(map.unproject(nwPoint, coords.z)),\n        // se = map.wrapLatLng(map.unproject(sePoint, coords.z));\n\n        nw = map.unproject(nwPoint, coords.z).wrap(),\n        se = map.unproject(sePoint, coords.z).wrap();\n\n    return new L.LatLngBounds(nw, se);\n  },\n\n  // converts cell coordinates to key for the cell cache\n  _cellCoordsToKey: function (coords) {\n    return coords.x + ':' + coords.y;\n  },\n\n  // converts cell cache key to coordiantes\n  _keyToCellCoords: function (key) {\n    var kArr = key.split(':'),\n        x = parseInt(kArr[0], 10),\n        y = parseInt(kArr[1], 10);\n\n    return new L.Point(x, y);\n  },\n\n  // remove any present cells that are off the specified bounds\n  _removeOtherCells: function (bounds) {\n    for (var key in this._cells) {\n      if (!bounds.contains(this._keyToCellCoords(key))) {\n        this._removeCell(key);\n      }\n    }\n  },\n\n  _removeCell: function (key) {\n    var cell = this._activeCells[key];\n    if(cell){\n      delete this._activeCells[key];\n\n      if (this.cellLeave) {\n        this.cellLeave(cell.bounds, cell.coords);\n      }\n\n      this.fire('cellleave', {\n        bounds: cell.bounds,\n        coords: cell.coords\n      }, true);\n    }\n  },\n\n  _removeCells: function(){\n    for (var key in this._cells) {\n      var bounds = this._cells[key].bounds;\n      var coords = this._cells[key].coords;\n\n      if (this.cellLeave) {\n        this.cellLeave(bounds, coords);\n      }\n\n      this.fire('cellleave', {\n        bounds: bounds,\n        coords: coords\n      }, true);\n    }\n  },\n\n  _addCell: function (coords) {\n\n    // wrap cell coords if necessary (depending on CRS)\n    this._wrapCoords(coords);\n\n    // generate the cell key\n    var key = this._cellCoordsToKey(coords);\n\n    // get the cell from the cache\n    var cell = this._cells[key];\n    // if this cell should be shown as isnt active yet (enter)\n\n    if (cell && !this._activeCells[key]) {\n      if (this.cellEnter) {\n        this.cellEnter(cell.bounds, coords);\n      }\n\n      this.fire('cellenter', {\n        bounds: cell.bounds,\n        coords: coords\n      }, true);\n\n      this._activeCells[key] = cell;\n    }\n\n    // if we dont have this cell in the cache yet (create)\n    if (!cell) {\n      cell = {\n        coords: coords,\n        bounds: this._cellCoordsToBounds(coords)\n      };\n\n      this._cells[key] = cell;\n      this._activeCells[key] = cell;\n\n      if(this.createCell){\n        this.createCell(cell.bounds, coords);\n      }\n\n      this.fire('cellcreate', {\n        bounds: cell.bounds,\n        coords: coords\n      }, true);\n    }\n  },\n\n  _wrapCoords: function (coords) {\n    coords.x = this._wrapLng ? L.Util.wrapNum(coords.x, this._wrapLng) : coords.x;\n    coords.y = this._wrapLat ? L.Util.wrapNum(coords.y, this._wrapLat) : coords.y;\n  },\n\n  // get the global cell coordinates range for the current zoom\n  _getCellNumBounds: function () {\n    var bounds = this._map.getPixelWorldBounds();\n    var size = this._getCellSize();\n\n    return bounds ? L.bounds(\n        bounds.min.divideBy(size).floor(),\n        bounds.max.divideBy(size).ceil().subtract([1, 1])) : null;\n  }\n\n});","(function(EsriLeaflet){\n\n  EsriLeaflet.Layers.FeatureManager = EsriLeaflet.Layers.FeatureGrid.extend({\n\n    /**\n     * Options\n     */\n\n    options: {\n      where: '1=1',\n      fields: ['*'],\n      from: false,\n      to: false,\n      timeField: false,\n      timeFilterMode: 'server',\n      simplifyFactor: 0,\n      precision: 6\n    },\n\n    /**\n     * Constructor\n     */\n\n    initialize: function (url, options) {\n      EsriLeaflet.Layers.FeatureGrid.prototype.initialize.call(this, options);\n\n      options = L.setOptions(this, options);\n\n      this.url = EsriLeaflet.Util.cleanUrl(url);\n\n      this._service = new EsriLeaflet.Services.FeatureLayer(this.url, options);\n      this._service.addEventParent(this);\n\n      //use case insensitive regex to look for common fieldnames used for indexing\n      /*global console */\n      if (this.options.fields[0] !== '*'){\n        var oidCheck = false;\n        for (var i = 0; i < this.options.fields.length; i++){\n          if (this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)){\n            oidCheck = true;\n          }\n        }\n        if (oidCheck === false && console && console.warn){\n          console.warn('no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.');\n        }\n      }\n\n      if(this.options.timeField.start && this.options.timeField.end){\n        this._startTimeIndex = new BinarySearchIndex();\n        this._endTimeIndex = new BinarySearchIndex();\n      } else if(this.options.timeField){\n        this._timeIndex = new BinarySearchIndex();\n      }\n\n      this._currentSnapshot = []; // cache of what layers should be active\n      this._activeRequests = 0;\n      this._pendingRequests = [];\n    },\n\n    /**\n     * Layer Interface\n     */\n\n    onAdd: function(map){\n      return EsriLeaflet.Layers.FeatureGrid.prototype.onAdd.call(this, map);\n    },\n\n    onRemove: function(map){\n      return EsriLeaflet.Layers.FeatureGrid.prototype.onRemove.call(this, map);\n    },\n\n    getAttribution: function () {\n      return this.options.attribution;\n    },\n\n    /**\n     * Feature Managment\n     */\n\n    createCell: function(bounds, coords){\n      this._requestFeatures(bounds, coords);\n    },\n\n    _requestFeatures: function(bounds, coords, callback){\n      this._activeRequests++;\n\n      // our first active request fires loading\n      if(this._activeRequests === 1){\n        this.fire('loading', {\n          bounds: bounds\n        }, true);\n      }\n\n      return this._buildQuery(bounds).run(function(error, featureCollection, response){\n        if(response && response.exceededTransferLimit){\n          this.fire('drawlimitexceeded', {}, true);\n        }\n\n        //deincriment the request counter\n        this._activeRequests--;\n\n        if(!error && featureCollection.features.length){\n          this._addFeatures(featureCollection.features, coords);\n        }\n\n        if(callback){\n          callback.call(this, error, featureCollection);\n        }\n\n        // if there are no more active requests fire a load event for this view\n        if(this._activeRequests <= 0){\n          this.fire('load', {\n            bounds: bounds\n          }, true);\n        }\n      }, this);\n    },\n\n    _addFeatures: function(features){\n      for (var i = features.length - 1; i >= 0; i--) {\n        var id = features[i].id;\n        this._currentSnapshot.push(id);\n      }\n\n      if(this.options.timeField){\n        this._buildTimeIndexes(features);\n      }\n\n      this.createLayers(features);\n    },\n\n    _buildQuery: function(bounds){\n      var query = this._service.query().intersects(bounds).where(this.options.where).fields(this.options.fields).precision(this.options.precision);\n\n      if(this.options.simplifyFactor){\n        query.simplify(this._map, this.options.simplifyFactor);\n      }\n\n      if(this.options.timeFilterMode === 'server' && this.options.from && this.options.to){\n        query.between(this.options.from, this.options.to);\n      }\n\n      return query;\n    },\n\n    /**\n     * Where Methods\n     */\n\n    setWhere: function(where, callback, context){\n\n      this.options.where = (where && where.length) ? where : '1=1';\n\n      var oldSnapshot = [];\n      var newShapshot = [];\n      var pendingRequests = 0;\n      var requestError = null;\n      var requestCallback = L.Util.bind(function(error, featureCollection){\n        if(error){\n          requestError = error;\n        }\n\n        if(featureCollection){\n          for (var i = featureCollection.features.length - 1; i >= 0; i--) {\n            newShapshot.push(featureCollection.features[i].id);\n          }\n        }\n\n        pendingRequests--;\n\n        if(pendingRequests <= 0){\n          this._currentSnapshot = newShapshot;\n          this.removeLayers(oldSnapshot);\n          this.addLayers(newShapshot);\n          if(callback) {\n            callback.call(context, requestError);\n          }\n        }\n      }, this);\n\n      for (var i = this._currentSnapshot.length - 1; i >= 0; i--) {\n        oldSnapshot.push(this._currentSnapshot[i]);\n      }\n\n      for(var key in this._activeCells){\n        pendingRequests++;\n        var coords = this._keyToCellCoords(key);\n        var bounds = this._cellCoordsToBounds(coords);\n        this._requestFeatures(bounds, key, requestCallback);\n      }\n\n      return this;\n    },\n\n    getWhere: function(){\n      return this.options.where;\n    },\n\n    /**\n     * Time Range Methods\n     */\n\n    getTimeRange: function(){\n      return [this.options.from, this.options.to];\n    },\n\n    setTimeRange: function(from, to, callback, context){\n      var oldFrom = this.options.from;\n      var oldTo = this.options.to;\n      var pendingRequests = 0;\n      var requestError = null;\n      var requestCallback = L.Util.bind(function(error){\n        if(error){\n          requestError = error;\n        }\n        this._filterExistingFeatures(oldFrom, oldTo, from, to);\n\n        pendingRequests--;\n\n        if(callback && pendingRequests <= 0){\n          callback.call(context, requestError);\n        }\n      }, this);\n\n      this.options.from = from;\n      this.options.to = to;\n\n      this._filterExistingFeatures(oldFrom, oldTo, from, to);\n\n      if(this.options.timeFilterMode === 'server') {\n        for(var key in this._activeCells){\n          pendingRequests++;\n          var coords = this._keyToCellCoords(key);\n          var bounds = this._cellCoordsToBounds(coords);\n          this._requestFeatures(bounds, key, requestCallback);\n        }\n      }\n    },\n\n    refresh: function(){\n      for(var key in this._activeCells){\n        var coords = this._keyToCellCoords(key);\n        var bounds = this._cellCoordsToBounds(coords);\n        this._requestFeatures(bounds, key);\n      }\n    },\n\n    _filterExistingFeatures: function (oldFrom, oldTo, newFrom, newTo) {\n      var layersToRemove = (oldFrom && oldTo) ? this._getFeaturesInTimeRange(oldFrom, oldTo) : this._currentSnapshot;\n      var layersToAdd = this._getFeaturesInTimeRange(newFrom, newTo);\n\n      if(layersToAdd.indexOf){\n        for (var i = 0; i < layersToAdd.length; i++) {\n          var shouldRemoveLayer = layersToRemove.indexOf(layersToAdd[i]);\n          if(shouldRemoveLayer >= 0){\n            layersToRemove.splice(shouldRemoveLayer, 1);\n          }\n        }\n      }\n\n      this.removeLayers(layersToRemove);\n      this.addLayers(layersToAdd);\n    },\n\n    _getFeaturesInTimeRange: function(start, end){\n      var ids = [];\n      var search;\n\n      if(this.options.timeField.start && this.options.timeField.end){\n        var startTimes = this._startTimeIndex.between(start, end);\n        var endTimes = this._endTimeIndex.between(start, end);\n        search = startTimes.concat(endTimes);\n      } else {\n        search = this._timeIndex.between(start, end);\n      }\n\n      for (var i = search.length - 1; i >= 0; i--) {\n        ids.push(search[i].id);\n      }\n\n      return ids;\n    },\n\n    _buildTimeIndexes: function(geojson){\n      var i;\n      var feature;\n      if(this.options.timeField.start && this.options.timeField.end){\n        var startTimeEntries = [];\n        var endTimeEntries = [];\n        for (i = geojson.length - 1; i >= 0; i--) {\n          feature = geojson[i];\n          startTimeEntries.push( {\n            id: feature.id,\n            value: new Date(feature.properties[this.options.timeField.start])\n          });\n          endTimeEntries.push( {\n            id: feature.id,\n            value: new Date(feature.properties[this.options.timeField.end])\n          });\n        }\n        this._startTimeIndex.bulkAdd(startTimeEntries);\n        this._endTimeIndex.bulkAdd(endTimeEntries);\n      } else {\n        var timeEntries = [];\n        for (i = geojson.length - 1; i >= 0; i--) {\n          feature = geojson[i];\n          timeEntries.push( {\n            id: feature.id,\n            value: new Date(feature.properties[this.options.timeField])\n          });\n        }\n\n        this._timeIndex.bulkAdd(timeEntries);\n      }\n    },\n\n    _featureWithinTimeRange: function(feature){\n      if(!this.options.from || !this.options.to){\n        return true;\n      }\n\n      var from = +this.options.from.valueOf();\n      var to = +this.options.to.valueOf();\n\n      if(typeof this.options.timeField === 'string'){\n        var date = +feature.properties[this.options.timeField];\n        return (date >= from) && (date <= to);\n      }\n\n      if(this.options.timeField.start &&  this.options.timeField.end){\n        var startDate = +feature.properties[this.options.timeField.start];\n        var endDate = +feature.properties[this.options.timeField.end];\n        return ((startDate >= from) && (startDate <= to)) || ((endDate >= from) && (endDate <= to));\n      }\n    },\n\n    /**\n     * Service Methods\n     */\n\n    authenticate: function(token){\n      this._service.authenticate(token);\n      return this;\n    },\n\n    metadata: function(callback, context){\n      this._service.metadata(callback, context);\n      return this;\n    },\n\n    query: function(){\n      return this._service.query();\n    },\n\n    addFeature: function(feature, callback, context){\n      this._service.addFeature(feature, function(error, response){\n        if(!error){\n          this.refresh();\n        }\n        if(callback){\n          callback.call(context, error, response);\n        }\n      }, this);\n      return this;\n    },\n\n    updateFeature: function(feature, callback, context){\n      return this._service.updateFeature(feature, function(error, response){\n        if(!error){\n          this.refresh();\n        }\n        if(callback){\n          callback.call(context, error, response);\n        }\n      }, this);\n    },\n\n    deleteFeature: function(id, callback, context){\n      return this._service.deleteFeature(id, function(error, response){\n        if(!error && response.objectId){\n          this.removeLayers([response.objectId], true);\n        }\n        if(callback){\n          callback.call(context, error, response);\n        }\n      }, this);\n    }\n  });\n\n  /**\n   * Temporal Binary Search Index\n   */\n\n  function BinarySearchIndex(values) {\n    this.values = values || [];\n  }\n\n  BinarySearchIndex.prototype._query = function(query){\n    var minIndex = 0;\n    var maxIndex = this.values.length - 1;\n    var currentIndex;\n    var currentElement;\n    var resultIndex;\n\n    while (minIndex <= maxIndex) {\n      resultIndex = currentIndex = (minIndex + maxIndex) / 2 | 0;\n      currentElement = this.values[Math.round(currentIndex)];\n      if (+currentElement.value < +query) {\n        minIndex = currentIndex + 1;\n      } else if (+currentElement.value > +query) {\n        maxIndex = currentIndex - 1;\n      } else {\n        return currentIndex;\n      }\n    }\n\n    return ~maxIndex;\n  };\n\n  BinarySearchIndex.prototype.sort = function(){\n    this.values.sort(function(a, b) {\n      return +b.value - +a.value;\n    }).reverse();\n    this.dirty = false;\n  };\n\n  BinarySearchIndex.prototype.between = function(start, end){\n    if(this.dirty){\n      this.sort();\n    }\n\n    var startIndex = this._query(start);\n    var endIndex = this._query(end);\n\n    if(startIndex === 0 && endIndex === 0){\n      return [];\n    }\n\n    startIndex = Math.abs(startIndex);\n    endIndex = (endIndex < 0) ? Math.abs(endIndex): endIndex + 1;\n\n    return this.values.slice(startIndex, endIndex);\n  };\n\n  BinarySearchIndex.prototype.bulkAdd = function(items){\n    this.dirty = true;\n    this.values = this.values.concat(items);\n  };\n\n})(EsriLeaflet);","EsriLeaflet.Layers.FeatureLayer = EsriLeaflet.Layers.FeatureManager.extend({\n\n  /**\n   * Constructor\n   */\n\n  initialize: function (url, options) {\n    EsriLeaflet.Layers.FeatureManager.prototype.initialize.call(this, url, options);\n\n    options = L.setOptions(this, options);\n\n    this._layers = {};\n  },\n\n  /**\n   * Layer Interface\n   */\n\n  onAdd: function(map){\n    return EsriLeaflet.Layers.FeatureManager.prototype.onAdd.call(this, map);\n  },\n\n  onRemove: function(map){\n\n    for (var i in this._layers) {\n      map.removeLayer(this._layers[i]);\n    }\n\n    return EsriLeaflet.Layers.FeatureManager.prototype.onRemove.call(this, map);\n  },\n\n  createNewLayer: function(geojson){\n    return L.GeoJSON.geometryToLayer(geojson, this.options);\n  },\n\n  /**\n   * Feature Managment Methods\n   */\n\n  createLayers: function(features){\n    for (var i = features.length - 1; i >= 0; i--) {\n\n      var geojson = features[i];\n\n      var layer = this._layers[geojson.id];\n      var newLayer;\n\n      if(layer && !this._map.hasLayer(layer)){\n        this._map.addLayer(layer);\n      }\n\n      if (layer && layer.setLatLngs) {\n        var updateGeo = this.createNewLayer(geojson);\n        layer.setLatLngs(updateGeo.getLatLngs());\n      }\n\n      if(!layer){\n\n        newLayer =  this.createNewLayer(geojson);\n        newLayer.feature = geojson;\n        newLayer.defaultOptions = newLayer.options;\n\n        // bubble events from layers to this\n        newLayer.addEventParent(this);\n\n        // bind a popup if we have one\n        if(this._popup && newLayer.bindPopup){\n          newLayer.bindPopup(this._popup(newLayer.feature, newLayer), this._popupOptions);\n        }\n\n        if(this.options.onEachFeature){\n          this.options.onEachFeature(newLayer.feature, newLayer);\n        }\n\n        // cache the layer\n        this._layers[newLayer.feature.id] = newLayer;\n\n        // style the layer\n        this.resetStyle(newLayer.feature.id);\n\n        this.fire('createfeature', {\n          feature: newLayer.feature\n        }, true);\n\n        // add the layer if it is within the time bounds or our layer is not time enabled\n        if(!this.options.timeField || (this.options.timeField && this._featureWithinTimeRange(geojson)) ){\n          this._map.addLayer(newLayer);\n        }\n      }\n    }\n  },\n\n  addLayers: function(ids){\n    for (var i = ids.length - 1; i >= 0; i--) {\n      var layer = this._layers[ids[i]];\n      if(layer){\n        this.fire('addfeature', {\n          feature: layer.feature\n        }, true);\n        this._map.addLayer(layer);\n      }\n    }\n  },\n\n  removeLayers: function(ids, permanent){\n    for (var i = ids.length - 1; i >= 0; i--) {\n      var id = ids[i];\n      var layer = this._layers[id];\n      if(layer){\n        this.fire('removefeature', {\n          feature: layer.feature,\n          permanent: permanent\n        }, true);\n        this._map.removeLayer(layer);\n      }\n      if(layer && permanent){\n        delete this._layers[id];\n      }\n    }\n  },\n\n  /**\n   * Styling Methods\n   */\n\n  resetStyle: function (id) {\n    var layer = this._layers[id];\n\n    if(layer){\n      layer.options = layer.defaultOptions;\n      this.setFeatureStyle(layer.feature.id, this.options.style);\n    }\n\n    return this;\n  },\n\n  setStyle: function (style) {\n    this.options.style = style;\n    this.eachFeature(function (layer) {\n      this.setFeatureStyle(layer.feature.id, style);\n    }, this);\n    return this;\n  },\n\n  setFeatureStyle: function (id, style) {\n    var layer = this._layers[id];\n\n    if (typeof style === 'function') {\n      style = style(layer.feature);\n    }\n    if (layer.setStyle) {\n      layer.setStyle(style);\n    }\n  },\n\n  /**\n   * Popup Methods\n   */\n\n  bindPopup: function (fn, options) {\n    this._popup = fn;\n    this._popupOptions = options;\n    for (var i in this._layers) {\n      var layer = this._layers[i];\n      var popupContent = this._popup(layer.feature, layer);\n      layer.bindPopup(popupContent, options);\n    }\n    return this;\n  },\n\n  unbindPopup: function () {\n    this._popup =  false;\n    for (var i in this._layers) {\n      var layer = this._layers[i];\n      if (layer.unbindPopup) {\n        layer.unbindPopup();\n      } else if (layer.getLayers) {\n        var groupLayers = layer.getLayers();\n        for (var j in groupLayers) {\n          var gLayer = groupLayers[j];\n          gLayer.unbindPopup();\n        }\n      }\n    }\n    return this;\n  },\n\n  /**\n   * Utility Methods\n   */\n\n  eachFeature: function (fn, context) {\n    for (var i in this._layers) {\n      fn.call(context, this._layers[i]);\n    }\n    return this;\n  },\n\n  getFeature: function (id) {\n    return this._layers[id];\n  }\n});\n\nEsriLeaflet.FeatureLayer = EsriLeaflet.Layers.FeatureLayer;\n\nEsriLeaflet.Layers.featureLayer = function(url, options){\n  return new EsriLeaflet.Layers.FeatureLayer(url, options);\n};\n\nEsriLeaflet.featureLayer = function(url, options){\n  return new EsriLeaflet.Layers.FeatureLayer(url, options);\n};\n","EsriLeaflet.Controls.Logo = L.Control.extend({\n  options: {\n    position: 'bottomright',\n    marginTop: 0,\n    marginLeft: 0,\n    marginBottom: 0,\n    marginRight: 0\n  },\n  onAdd: function () {\n    var div = L.DomUtil.create('div', 'esri-leaflet-logo');\n    div.style.marginTop = this.options.marginTop;\n    div.style.marginLeft = this.options.marginLeft;\n    div.style.marginBottom = this.options.marginBottom;\n    div.style.marginRight = this.options.marginRight;\n    div.innerHTML = '<a href=\"https://developers.arcgis.com\" style=\"border: none;\"><img src=\"http://js.arcgis.com/3.10/js/esri/images/map/logo-med.png\" style=\"border: none;\"></a>';\n    return div;\n  }\n});\n\nEsriLeaflet.Controls.logo = function(options){\n  return new L.esri.Controls.Logo(options);\n};"]}